<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Extract Amenities with Type and Display</title>
</head>
<body>
  <h1>Extract Amenities from JSON File with Type and Display</h1>

  <a id="downloadLink" style="display:none" download="extracted_amenities.json">Download Results</a>

  <script>
    
/////////////////////////////////////////////////////////////////////////////////////////////////////
    function determineType(tags) {
      if (tags.amenity === 'drinking_water' && tags.man_made === 'water_tap') {
        return 'Robinet';
      } else if (tags.amenity === 'toilets') {
        return 'Toilettes';
      } else if (tags.amenity === 'fountain') {
        return 'Fontaine';
      }
      return "Point d'Eau";
    } //function determineType

/////////////////////////////////////////////////////////////////////////////////////////////////////
    function extractAmenities(data) {
      const excludedAccessValues = new Set(['no', 'permit', 'private']);
      const excludedDrinkingWaterValues = new Set(['no', 'untreated']);
      const extracted = [];

      if (data.elements && Array.isArray(data.elements)) {
        data.elements.forEach(element => {
          if (element.tags && element.tags.amenity && element.lat && element.lon) {
            const tags = element.tags;

            if (
              !excludedAccessValues.has(tags.access) &&
              !excludedDrinkingWaterValues.has(tags.drinking_water) &&
              tags.operational_status !== 'closed' &&
              tags.water_point !== 'yes'
            ) {
              const hasDisused = Object.values(tags).some(value =>
                typeof value === 'string' && value.toLowerCase().includes('disused')
              );
              if (!hasDisused) {
                extracted.push({
                  Lat: element.lat,
                  Lon: element.lon,
                  Type: determineType(tags),
                  Display: 'Y'
                });
              }
            }
          }
        });
      }

      return extracted;
    } // function extractAmenities

/////////////////////////////////////////////////////////////////////////////////////////////////////
    async function getData() {
      
      let qy = '[out:json][timeout:25];('+
        'node["amenity"="drinking_water"](42.310099, 1.721397, 43.055034, 3.304637);'+
        'node["amenity"="fountain"](42.310099, 1.721397, 43.055034, 3.304637);'+
        'node["amenity"="toilets"](42.310099, 1.721397, 43.055034, 3.304637);'+
        'node["amenity"="water_point"](42.310099, 1.721397, 43.055034, 3.304637);'+
        'node["man_made"="water_tap"](42.310099, 1.721397, 43.055034, 3.304637);'+
        ');out geom;';
      // The Overpass API expects the query string as 'data=<url_encoded_query>' in the POST body.
      // The entire 'data=' string also needs to be URL-encoded for the body.
      
      let postBody = 'data=' + encodeURIComponent(qy); // Correctly format the POST body

var uri = "https://overpass-api.de/api/interpreter";

var result = await fetch(uri, {
  method:'POST',
  // Explicitly set Content-Type for 'application/x-www-form-urlencoded'
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded'
  },
  body: postBody // Use the correctly formatted body
}).then(data => {
  if (!data.ok) { // Check if the response was successful
    throw new Error(`HTTP error! status: ${data.status}`);
  }
  return data.json();
}).then(text => {
  console.log("Success:", text);
}).catch(error => {
  console.error("Error fetching data:", error);
});
      
      } //async function getData
      
/////////////////////////////////////////////////////////////////////////////////////////////////////

    let jsonData = await getData();
    
    const downloadLink = document.getElementById('downloadLink');

         const results = extractAmenities(jsonData);
          const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);

          downloadLink.href = url;
          downloadLink.style.display = 'inline-block';
          downloadLink.textContent = `Download ${results.length} extracted entries`;

  </script>
</body>
</html>
