<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Extract Amenities with Type and Display</title>
</head>
<body>
  <h1>Extract Amenities from JSON File with Type and Display</h1>

  <a id="downloadLink" style="display:none" download="extracted_amenities.json">Download Results</a>

  <script>
    
/////////////////////////////////////////////////////////////////////////////////////////////////////
    function determineType(tags) {
      if (tags.amenity === 'drinking_water' && tags.man_made === 'water_tap') {
        return 'Robinet';
      } else if (tags.amenity === 'toilets') {
        return 'Toilettes';
      } else if (tags.amenity === 'fountain') {
        return 'Fontaine';
      }
      return "Point d'Eau";
    } //function determineType

/////////////////////////////////////////////////////////////////////////////////////////////////////
    function extractAmenities(data) {
      const excludedAccessValues = new Set(['no', 'permit', 'private']);
      const excludedDrinkingWaterValues = new Set(['no', 'untreated']);
      const extracted = [];

      if (data.elements && Array.isArray(data.elements)) {
        data.elements.forEach(element => {
          if (element.tags && element.tags.amenity && element.lat && element.lon) {
            const tags = element.tags;

            if (
              !excludedAccessValues.has(tags.access) &&
              !excludedDrinkingWaterValues.has(tags.drinking_water) &&
              tags.operational_status !== 'closed' &&
              tags.water_point !== 'yes'
            ) {
              const hasDisused = Object.values(tags).some(value =>
                typeof value === 'string' && value.toLowerCase().includes('disused')
              ); //const hasDisused = Object.values(tags).some
              if (!hasDisused) {
                extracted.push({
                  Lat: element.lat,
                  Lon: element.lon,
                  Type: determineType(tags),
                  Display: 'Y'
                }); //extracted.push
              } //if (!hasDisused)
            } //if (!excludedAccessValues.has(tags.access) &&...
          } //if (element.tags && element.tags.amenity && element.lat && element.lon)
        }); //data.elements.forEach
      } //if (data.elements && Array.isArray(data.elements))

      return extracted;
      
    } // function extractAmenities

/////////////////////////////////////////////////////////////////////////////////////////////////////
async function getData() {
  // needs to be async because it uses an await on a fetch

  const southLat = 42.310099;
  const westLon = 1.721397;
  const northLat = 43.055034;
  const eastLon = 3.304637;
  
  let qy = '[out:json][timeout:25];('+
    'node["amenity"="drinking_water"](southLat, westLon, northLat, eastLon);'+
    'node["amenity"="fountain"](southLat, westLon, northLat, eastLon);'+
    'node["amenity"="toilets"](southLat, westLon, northLat, eastLon);'+
    'node["amenity"="water_point"](southLat, westLon, northLat, eastLon);'+
    'node["man_made"="water_tap"](southLat, westLon, northLat, eastLon);'+
    ');out geom;';

  let postBody = 'data=' + encodeURIComponent(qy);
  let uri = "https://overpass-api.de/api/interpreter";

  try { // await needs a try/catch. here, one try/catch covers two awaits
    const response = await fetch(uri, {
      method:'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: postBody
    }); //const response = await fetch

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const data = await response.json();
    return data;
  } catch (error) {
    console.error("Error fetching data:", error);
    throw error; // Re-throw to let main() handle it
  } //try
}/////////////////////////////////////////////////////////////////////////////////////////////////////

async function main() {
  // async because it does an await on getData()
  try {
    // await needs a try/catch
    const data = await getData(); // Wait for the fetch to complete and get the JSON
    const results = extractAmenities(data); // Now extract amenities from the actual JSON

    const downloadLink = document.getElementById('downloadLink');
    const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);

    downloadLink.href = url;
    downloadLink.style.display = 'inline-block';
    downloadLink.textContent = `Download ${results.length} extracted entries`;
  } catch (error) {
    console.error("Error in main execution:", error);
  } //try
} //async function main
    
main();
    // this code doesn't use then
    
  </script>
</body>
</html>
